<!DOCTYPE html>
  
  
  
  
   <html class="no-js"> 

  <head lang="en-us">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <title>ActiveTcl 8.6.9 Documentation</title>
    <meta name="generator" content="Hugo 0.26" />

    
    <meta name="description" content="Complete documentation for ActiveTcl 8.6.9">
    
    <link rel="canonical" href="ttrace.html">
    

    
    <meta name="apple-mobile-web-app-title" content="ActiveTcl 8.6.9 Documentation">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="shortcut icon" type="image/x-icon" href="../../../images/favicon.ico">
    <link rel="icon" type="image/x-icon" href="../../../images/favicon.ico">

    <style>
      @font-face {
        font-family: 'Icon';
        src: url('../../../fonts/icon.eot');
        src: url('../../../fonts/icon.eot')
               format('embedded-opentype'),
             url('../../../fonts/icon.woff')
               format('woff'),
             url('../../../fonts/icon.ttf')
               format('truetype'),
             url('../../../fonts/icon.svg')
               format('svg');
        font-weight: normal;
        font-style: normal;
      }
    </style>

    <link rel="stylesheet" href="../../../stylesheets/application.css">
    <link rel="stylesheet" href="../../../stylesheets/temporary.css">
    <link rel="stylesheet" href="../../../stylesheets/palettes.css">
    <link rel="stylesheet" href="../../../stylesheets/highlight/highlight.css">

    
    
    
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open%20Sans:400,700|Source+Code+Pro">
    <style>
      body, input {
        font-family: 'Open Sans', Helvetica, Arial, sans-serif;
      }
      pre, code {
        font-family: 'Source Code Pro', 'Courier New', 'Courier', monospace;
      }
    </style>

    
    <link rel="stylesheet" href="../../../stylesheets/as_common.css">
    
    <link rel="stylesheet" href="../../../stylesheets/as_custom.css">
    
    <script src="../../../javascripts/modernizr.js"></script>

    

  </head>
  <body class="palette-primary-grey palette-accent-red">




<div class="backdrop">
	<div class="backdrop-paper"></div>
</div>

<input class="toggle" type="checkbox" id="toggle-drawer">
<input class="toggle" type="checkbox" id="toggle-search">
<label class="toggle-button overlay" for="toggle-drawer"></label>

<header class="header">
	<nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="logo">
        <a href="http://www.activestate.com/">
          <img src="../../../images/logo.png" alt="ActiveState homepage">
        </a>
      </div>
      <div class="title">
        <a href="http://docs.activestate.com/">docs.activestate.com</a>
      </div>
    </div>

    

    
    
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>

</header>

<main class="main">
	<div class="drawer">
		<nav aria-label="Navigation">
  <a href="../../../index.html" class="project">
    <div class="banner">
      
        <div class="logo">
          <img src="../../../images/as_tcl.png">
        </div>
      
      <div class="name">
        <strong>ActiveTcl 8.6.9 Documentation </strong>
        
      </div>
    </div>
  </a>

  <div class="scrollable">
    <div class="wrapper">
      

      <div class="toc">
        
        <ul>
          




<li>
  



<a  title="Get ActiveTcl" href="../../../get/index.html">
	
	Get ActiveTcl
</a>



  
    <ul>
      
        
        



<a  title="Release notes" href="../../../get/relnotes/index.html">
	
	Release notes
</a>



      
        
        



<a  title="Windows installation" href="../../../get/windows/index.html">
	
	Windows installation
</a>



      
        
        



<a  title="Linux/Unix Installaton" href="../../../get/linux/index.html">
	
	Linux/Unix Installaton
</a>



      
        
        



<a  title="macOS Installation" href="../../../get/macos/index.html">
	
	macOS Installation
</a>



      
        
        



<a  title="License" href="../../../get/license/index.html">
	
	License
</a>



      
    </ul>
  
</li>



<li>
  



<a  title="Get Started" href="../../../start/index.html">
	
	Get Started
</a>



  
    <ul>
      
        
        



<a  title="Package Reference" href="../../../pkg/index.html">
	
	Package Reference
</a>



      
        
        



<a  title="Tcl 8.6.9 docs" href="../../contents.html">
	
	Tcl 8.6.9 docs
</a>



      
    </ul>
  
</li>



<li>
  



<a  title="Contact Us" href="../../../contact/index.html">
	
	Contact Us
</a>



  
</li>


        </ul>
        

        
      </div>
    </div>
  </div>
</nav>

	</div>

	<article class="article">
		<div class="wrapper">
			<h1> </h1>

			<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="HTML Tidy, see www.w3.org">
<title>ttrace - Tcl Threading</title>
<meta name='Author' content='ActiveState'>

</head>
<body>
<div class="doctools">


<hr>
[ <a
href="../toc.html">Thread Table Of Contents</a> | <a href=
"../index.html">Thread Index</a> ] 

<hr>
<h1 class="title">ttrace(n) 2.7 "Tcl Threading"</h1>

<div id="name" class="section">
<h2><a name="name">Name</a></h2>

<p>ttrace - Trace-based interpreter initialization</p>
</div>

<div id="toc" class="section">
<h2><a name="toc">Table Of Contents</a></h2>

<ul class="toc">
<li class="section"><a href="ttrace.html#toc">Table Of Contents</a></li>

<li class="section"><a href="ttrace.html#synopsis">Synopsis</a></li>

<li class="section"><a href="ttrace.html#section1">Description</a></li>

<li class="section"><a href="ttrace.html#section2">USER COMMANDS</a></li>

<li class="section"><a href="ttrace.html#section3">CALLBACK COMMANDS</a></li>

<li class="section"><a href="ttrace.html#section4">DISCUSSION</a></li>

<li class="section"><a href="ttrace.html#see-also">See Also</a></li>

<li class="section"><a href="ttrace.html#keywords">Keywords</a></li>
</ul>
</div>

<div id="synopsis" class="section">
<h2><a name="synopsis">Synopsis</a></h2>

<div class="synopsis">
<ul class="requirements">
<li>package require <b class="pkgname">Tcl 8.4</b></li>

<li>package require <b class="pkgname">Thread <span class=
"opt">?2.7?</span></b></li>
</ul>

<ul class="syntax">
<li><a href="ttrace.html#1"><b class="cmd">ttrace::eval</b> <i class=
"arg">arg</i> <span class="opt">?arg ...?</span></a></li>

<li><a href="ttrace.html#2"><b class="cmd">ttrace::enable</b></a></li>

<li><a href="ttrace.html#3"><b class="cmd">ttrace::disable</b></a></li>

<li><a href="ttrace.html#4"><b class="cmd">ttrace::cleanup</b></a></li>

<li><a href="ttrace.html#5"><b class="cmd">ttrace::update</b> <span class=
"opt">?epoch?</span></a></li>

<li><a href="ttrace.html#6"><b class="cmd">ttrace::getscript</b></a></li>

<li><a href="ttrace.html#7"><b class="cmd">ttrace::atenable</b> <i class=
"arg">cmd</i> <i class="arg">arglist</i> <i class=
"arg">body</i></a></li>

<li><a href="ttrace.html#8"><b class="cmd">ttrace::atdisable</b> <i class=
"arg">cmd</i> <i class="arg">arglist</i> <i class=
"arg">body</i></a></li>

<li><a href="ttrace.html#9"><b class="cmd">ttrace::addtrace</b> <i class=
"arg">cmd</i> <i class="arg">arglist</i> <i class=
"arg">body</i></a></li>

<li><a href="ttrace.html#10"><b class="cmd">ttrace::addscript</b> <i class=
"arg">name</i> <i class="arg">body</i></a></li>

<li><a href="ttrace.html#11"><b class="cmd">ttrace::addresolver</b> <i class=
"arg">cmd</i> <i class="arg">arglist</i> <i class=
"arg">body</i></a></li>

<li><a href="ttrace.html#12"><b class="cmd">ttrace::addcleanup</b> <i class=
"arg">body</i></a></li>

<li><a href="ttrace.html#13"><b class="cmd">ttrace::addentry</b> <i class=
"arg">cmd</i> <i class="arg">var</i> <i class=
"arg">val</i></a></li>

<li><a href="ttrace.html#14"><b class="cmd">ttrace::getentry</b> <i class=
"arg">cmd</i> <i class="arg">var</i></a></li>

<li><a href="ttrace.html#15"><b class="cmd">ttrace::getentries</b> <i class=
"arg">cmd</i> <span class="opt">?pattern?</span></a></li>

<li><a href="ttrace.html#16"><b class="cmd">ttrace::delentry</b> <i class=
"arg">cmd</i></a></li>

<li><a href="ttrace.html#17"><b class="cmd">ttrace::preload</b> <i class=
"arg">cmd</i></a></li>
</ul>
</div>
</div>

<div id="section1" class="section">
<h2><a name="section1">Description</a></h2>

<p>This package creates a framework for on-demand replication of
the interpreter state accross threads in an multithreading
application. It relies on the mechanics of Tcl command tracing and
the Tcl <b class="cmd">unknown</b> command and mechanism.</p>

<p>The package requires Tcl threading extension but can be
alternatively used stand-alone within the AOLserver, a scalable
webserver from America Online.</p>

<p>In a nutshell, a short sample illustrating the usage of the
ttrace with the Tcl threading extension:</p>

<pre class="example">
    % package require Ttrace
    2.7.0
    % set t1 [thread::create {package require Ttrace; thread::wait}]
    tid0x1802800
    % ttrace::eval {proc test args {return test-[thread::id]}}
    % thread::send $t1 test
    test-tid0x1802800
    % set t2 [thread::create {package require Ttrace; thread::wait}]
    tid0x1804000
    % thread::send $t2 test
    test-tid0x1804000
</pre>

<p>As seen from above, the <b class="cmd">ttrace::eval</b> and <b
class="cmd">ttrace::update</b> commands are used to create a
thread-wide definition of a simple Tcl procedure and replicate that
definition to all, already existing or later created, threads.</p>
</div>

<div id="section2" class="section">
<h2><a name="section2">USER COMMANDS</a></h2>

<p>This section describes user-level commands. Those commands can
be used by script writers to control the execution of the tracing
framework.</p>

<dl class="definitions">
<dt><a name="1"><b class="cmd">ttrace::eval</b> <i class=
"arg">arg</i> <span class="opt">?arg ...?</span></a></dt>

<dd>
<p>This command concatenates given arguments and evaluates the
resulting Tcl command with trace framework enabled. If the command
execution was ok, it takes necessary steps to automatically
propagate the trace epoch change to all threads in the application.
For AOLserver, only newly created threads actually receive the
epoch change. For the Tcl threading extension, all threads created
by the extension are automatically updated. If the command
execution resulted in Tcl error, no state propagation takes
place.</p>

<p>This is the most important user-level command of the package as
it wraps most of the commands described below. This greatly
simplifies things, because user need to learn just this (one)
command in order to effectively use the package. Other commands, as
desribed below, are included mostly for the sake of
completeness.</p>
</dd>

<dt><a name="2"><b class="cmd">ttrace::enable</b></a></dt>

<dd>
<p>Activates all registered callbacks in the framework and starts a
new trace epoch. The trace epoch encapsulates all changes done to
the interpreter during the time traces are activated.</p>
</dd>

<dt><a name="3"><b class="cmd">ttrace::disable</b></a></dt>

<dd>
<p>Deactivates all registered callbacks in the framework and closes
the current trace epoch.</p>
</dd>

<dt><a name="4"><b class="cmd">ttrace::cleanup</b></a></dt>

<dd>
<p>Used to clean-up all on-demand loaded resources in the
interpreter. It effectively brings Tcl interpreter to its pristine
state.</p>
</dd>

<dt><a name="5"><b class="cmd">ttrace::update</b> <span class=
"opt">?epoch?</span></a></dt>

<dd>
<p>Used to refresh the state of the interpreter to match the
optional trace <span class="opt">?epoch?</span>. If the optional
<span class="opt">?epoch?</span> is not given, it takes the most
recent trace epoch.</p>
</dd>

<dt><a name="6"><b class="cmd">ttrace::getscript</b></a></dt>

<dd>
<p>Returns a synthetized Tcl script which may be sourced in any
interpreter. This script sets the stage for the Tcl <b class=
"cmd">unknown</b> command so it can load traced resources from the
in-memory database. Normally, this command is automatically invoked
by other higher-level commands like <b class="cmd">ttrace::eval</b>
and <b class="cmd">ttrace::update</b>.</p>
</dd>
</dl>
</div>

<div id="section3" class="section">
<h2><a name="section3">CALLBACK COMMANDS</a></h2>

<p>A word upfront: the package already includes callbacks for
tracing following Tcl commands: <b class="cmd">proc</b>, <b class=
"cmd">namespace</b>, <b class="cmd">variable</b>, <b class=
"cmd">load</b>, and <b class="cmd">rename</b>. Additionaly, a set
of callbacks for tracing resources (object, clasess) for the XOTcl
v1.3.8+, an OO-extension to Tcl, is also provided. This gives a
solid base for solving most of the real-life needs and serves as an
example for people wanting to customize the package to cover their
specific needs.</p>

<p>Below, you can find commands for registering callbacks in the
framework and for writing callback scripts. These callbacks are
invoked by the framework in order to gather interpreter state
changes, build in-memory database, perform custom-cleanups and
various other tasks.</p>

<dl class="definitions">
<dt><a name="7"><b class="cmd">ttrace::atenable</b> <i class=
"arg">cmd</i> <i class="arg">arglist</i> <i class=
"arg">body</i></a></dt>

<dd>
<p>Registers Tcl callback to be activated at <b class=
"cmd">ttrace::enable</b>. Registered callbacks are activated on
FIFO basis. The callback definition includes the name of the
callback, <i class="arg">cmd</i>, a list of callback arguments, <i
class="arg">arglist</i> and the <i class="arg">body</i> of the
callback. Effectively, this actually resembles the call interface
of the standard Tcl <b class="cmd">proc</b> command.</p>
</dd>

<dt><a name="8"><b class="cmd">ttrace::atdisable</b> <i class=
"arg">cmd</i> <i class="arg">arglist</i> <i class=
"arg">body</i></a></dt>

<dd>
<p>Registers Tcl callback to be activated at <b class=
"cmd">ttrace::disable</b>. Registered callbacks are activated on
FIFO basis. The callback definition includes the name of the
callback, <i class="arg">cmd</i>, a list of callback arguments, <i
class="arg">arglist</i> and the <i class="arg">body</i> of the
callback. Effectively, this actually resembles the call interface
of the standard Tcl <b class="cmd">proc</b> command.</p>
</dd>

<dt><a name="9"><b class="cmd">ttrace::addtrace</b> <i class=
"arg">cmd</i> <i class="arg">arglist</i> <i class=
"arg">body</i></a></dt>

<dd>
<p>Registers Tcl callback to be activated for tracing the Tcl <b
class="cmd">cmd</b> command. The callback definition includes the
name of the Tcl command to trace, <i class="arg">cmd</i>, a list of
callback arguments, <i class="arg">arglist</i> and the <i class=
"arg">body</i> of the callback. Effectively, this actually
resembles the call interface of the standard Tcl <b class=
"cmd">proc</b> command.</p>
</dd>

<dt><a name="10"><b class="cmd">ttrace::addscript</b> <i class=
"arg">name</i> <i class="arg">body</i></a></dt>

<dd>
<p>Registers Tcl callback to be activated for building a Tcl script
to be passed to other interpreters. This script is used to set the
stage for the Tcl <b class="cmd">unknown</b> command. Registered
callbacks are activated on FIFO basis. The callback definition
includes the name of the callback, <i class="arg">name</i> and the
<i class="arg">body</i> of the callback.</p>
</dd>

<dt><a name="11"><b class="cmd">ttrace::addresolver</b> <i class=
"arg">cmd</i> <i class="arg">arglist</i> <i class=
"arg">body</i></a></dt>

<dd>
<p>Registers Tcl callback to be activated by the overloaded Tcl <b
class="cmd">unknown</b> command. Registered callbacks are activated
on FIFO basis. This callback is used to resolve the resource and
load the resource in the current interpreter.</p>
</dd>

<dt><a name="12"><b class="cmd">ttrace::addcleanup</b> <i class=
"arg">body</i></a></dt>

<dd>
<p>Registers Tcl callback to be activated by the <b class=
"cmd">trace::cleanup</b>. Registered callbacks are activated on
FIFO basis.</p>
</dd>

<dt><a name="13"><b class="cmd">ttrace::addentry</b> <i class=
"arg">cmd</i> <i class="arg">var</i> <i class=
"arg">val</i></a></dt>

<dd>
<p>Adds one entry to the named in-memory database.</p>
</dd>

<dt><a name="14"><b class="cmd">ttrace::getentry</b> <i class=
"arg">cmd</i> <i class="arg">var</i></a></dt>

<dd>
<p>Returns the value of the entry from the named in-memory
database.</p>
</dd>

<dt><a name="15"><b class="cmd">ttrace::getentries</b> <i class=
"arg">cmd</i> <span class="opt">?pattern?</span></a></dt>

<dd>
<p>Returns names of all entries from the named in-memory
database.</p>
</dd>

<dt><a name="16"><b class="cmd">ttrace::delentry</b> <i class=
"arg">cmd</i></a></dt>

<dd>
<p>Deletes an entry from the named in-memory database.</p>
</dd>

<dt><a name="17"><b class="cmd">ttrace::preload</b> <i class=
"arg">cmd</i></a></dt>

<dd>
<p>Registers the Tcl command to be loaded in the interpreter.
Commands registered this way will always be the part of the
interpreter and not be on-demand loaded by the Tcl <b class=
"cmd">unknown</b> command.</p>
</dd>
</dl>
</div>

<div id="section4" class="section">
<h2><a name="section4">DISCUSSION</a></h2>

<p>Common introspective state-replication approaches use a custom
Tcl script to introspect the running interpreter and synthesize
another Tcl script to replicate this state in some other
interpreter. This package, on the contrary, uses Tcl command
traces. Command traces are registered on selected Tcl commands,
like <b class="cmd">proc</b>, <b class="cmd">namespace</b>, <b
class="cmd">load</b> and other standard (and/or user-defined) Tcl
commands. When activated, those traces build an in-memory database
of created resources. This database is used as a resource
repository for the (overloaded) Tcl <b class="cmd">unknown</b>
command which creates the requested resource in the interpreter on
demand. This way, users can update just one interpreter (master) in
one thread and replicate that interpreter state (or part of it) to
other threads/interpreters in the process.</p>

<p>Immediate benefit of such approach is the much smaller memory
footprint of the application and much faster thread creation. By
not actually loading all necessary procedures (and other resources)
in every thread at the thread initialization time, but by deffering
this to the time the resource is actually referenced, significant
improvements in both memory consumption and thread initialization
time can be achieved. Some tests have shown that memory footprint
of an multithreading Tcl application went down more than three
times and thread startup time was reduced for about 50 times. Note
that your mileage may vary. Other benefits include much finer
control about what (and when) gets replicated from the master to
other Tcl thread/interpreters.</p>
</div>

<div id="see-also" class="section">
<h2><a name="see-also">See Also</a></h2>

<p><a href="thread.html">thread</a>, <a href=
"tpool.html">tpool</a>, <a href="tsv.html">tsv</a></p>
</div>

<div id="keywords" class="section">
<h2><a name="keywords">Keywords</a></h2>

<p><a href="../index.html#key0">command tracing</a>, <a href=
"../index.html#key2">introspection</a></p>
</div>

<h4>Copyright &copy; 2015 <a href="http://www.activestate.com">for
compilation: ActiveState</a></h4>
</div>
</body>
</html>



			<aside class="copyright" role="note">
				
				Documentation built with
				<a href="https://www.gohugo.io" target="_blank">Hugo</a>
				using the
				<a href="http://github.com/digitalcraftsman/hugo-material-docs" target="_blank">Material</a> theme.
			</aside>

			<footer class="footer">
				<div class="as_footer">
  
  <div class="prod_links">
    <strong>
      <a href="http://platform.activestate.com/" target="_blank">ActiveState Platform</a>&nbsp;&nbsp;
      <a href="http://www.activestate.com/downloads" target="_blank">Downloads</a>&nbsp;&nbsp;
      <a href="http://community.activestate.com/" target="_blank">Community</a>&nbsp;&nbsp;
      <a href="http://github.com/activestate/code" target="_blank">Code Recipes</a>&nbsp;&nbsp;
    </strong>
  </div>
  <div class="as_copyright"> 
    &copy; 2019 ActiveState Software Inc. All rights reserved. <strong><a href="../../../trademarks/index.html">Trademarks</a>. <a href="http://www.activestate.com/privacy-policy">Privacy Policy</a>.</strong>
  </div>
</div>

			</footer>
		</div>
	</article>

	<div class="results" role="status" aria-live="polite">
		<div class="scrollable">
			<div class="wrapper">
				<div class="meta"></div>
				<div class="list"></div>
			</div>
		</div>
	</div>
</main>

    <script>
    
      var base_url = '';
      var repo_id  = '';
    
    </script>

    <script src="../../../javascripts/application.js"></script>
    

    <script>
      /* Add headers to scrollspy */
      var headers   = document.getElementsByTagName("h2");
      var scrollspy = document.getElementById('scrollspy');

      if(scrollspy) {
        if(headers.length > 0) {
          for(var i = 0; i < headers.length; i++) {
            var li = document.createElement("li");
            li.setAttribute("class", "anchor");

            var a  = document.createElement("a");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", headers[i].innerHTML);
            a.innerHTML = headers[i].innerHTML;

            li.appendChild(a)
            scrollspy.appendChild(li);
          }
        } else {
          scrollspy.parentElement.removeChild(scrollspy)
        }


        /* Add permanent link next to the headers */
        var headers = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

        for(var i = 0; i < headers.length; i++) {
            var a = document.createElement("a");
            a.setAttribute("class", "headerlink");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", "Permanent link")
            a.innerHTML = "¶";
            headers[i].appendChild(a);
        }
      }
    </script>

    
      <script>
        (function(i,s,o,g,r,a,m){
          i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||
          []).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;
          m.parentNode.insertBefore(a,m)
        })(window, document,
          'script', '//www.google-analytics.com/analytics.js', 'ga');
         
        ga('create', 'UA-20072-24', 'auto');
        ga('set', 'anonymizeIp', true);
        ga('send', 'pageview');
         
        var buttons = document.querySelectorAll('a');
        Array.prototype.map.call(buttons, function(item) {
          if (item.host != document.location.host) {
            item.addEventListener('click', function() {
              var action = item.getAttribute('data-action') || 'follow';
              ga('send', 'event', 'outbound', action, item.href);
            });
          }
        });
         
        var query = document.querySelector('.query');
        query.addEventListener('blur', function() {
          if (this.value) {
            var path = document.location.pathname;
            ga('send', 'pageview', path + '?q=' + this.value);
          }
        });
      </script>
    

    <script src="../../../javascripts/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

